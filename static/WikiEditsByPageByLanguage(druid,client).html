<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="facet.css">
    <script src="lib/underscore.js"></script>
    <script src="lib/async.js"></script>
    <script src="lib/d3.v3.js"></script>
    <script src="lib/jquery-1.9.1.js"></script>
    <script src="facet.js"></script>
    <script src="driverUtil.js"></script>
    <script src="simpleDriver.js"></script>
    <script src="sqlDriver.js"></script>
    <script src="druidDriver.js"></script>

    <title>Facet Examples (0.2.1)</title>

    <script>
      // The basics
      var filter = facet.filter;
      var split = facet.split;
      var apply = facet.apply;
      var layout = facet.layout;
      var scale = facet.scale;
      var plot = facet.plot;
      var use = facet.use;
      var combine = facet.combine;
      var sort = facet.sort;
      var transform = facet.transform;
    </script>
  </head>

  <body>

    <div class="cont">
      <h1>Wiki Edits by Page by Language</h1>
      <h2>Druid Driver in Client / wikipedia</h2>
      <div class="example"></div>
    </div>
    <script>
    (function() {
      // dimensions
      // ["dma_code","continent_code","geo","area_code","robot","country_name","network","city","namespace","anonymous","unpatrolled","page","postal_code","language","newpage","user","region_lookup"]
      // metrics
      // ["count","added","variation","delta","delta_hist","unique_users","deleted"]}

      var druidRequester = facet.ajaxPoster({
        url: '/pass/druid',
        prety: true
      });

      var druidDriverClient = druidDriver({
        requester: druidRequester,
        dataSource: "wikipedia_editstream",
        filter: {
          type: 'within',
          range: [
            new Date(Date.UTC(2013, 2-1, 26, 0, 0, 0)),
            new Date(Date.UTC(2013, 2-1, 27, 0, 0, 0))
          ],
        }
      });

      // var sqlRequester = facet.ajaxPoster({
      //   url: '/pass/sql',
      //   prety: true
      // });

      // var sqlDriverClient = sqlDriver({
      //   requester: sqlRequester,
      //   table: "wiki_day",
      //   filter: null
      // });

      function formatEditsAndPage(edits, page) {
        var str = '(' + edits + ') ' + page;
        var lim = 100;
        if (str.length > lim) {
          str = str.substring(0, lim) + '...';
        }
        return str;
      }

      facet.define('.example', 800, 600, facet.verboseDriver(druidDriverClient))
        .apply('Edits', apply.count())
        .scale('horiz', scale.linear())
          .split('Language', split.identity('language'))
          .apply('Edits', apply.count())
          .combine(combine.slice(sort.natural('Edits', 'descending'), 4))
          .layout(layout.vertical({ gap: 3 }))
          .plot(plot.box({
            fill: 'none',
            stroke: 'black'
          }))
          .transform(transform.rectangle.point({ top: 10, left: 8 }))
            .plot(plot.label({
              text: use.prop('Language'),
              baseline: 'top',
              size: '30px'
            }))
          .untransform()
          .transform(transform.rectangle.point({ top: 40, left: 8 }))
            .plot(plot.label({
              text: use.fn(use.prop('Edits'), function(d) { return 'Total edits: ' + d; }),
              baseline: 'top'
            }))
          .untransform()
            .split('Page', split.identity('page'))
            .apply('Edits', apply.count())
            .combine(combine.slice(sort.natural('Edits', 'descending'), 4))
            .layout(layout.vertical({ gap: 3 }))
            .transform(transform.rectangle.rectangle({ left: 200 }))
              .domain('horiz', use.interval(0, use.prop('Edits')))
              .range('horiz', use.stage('width'))
              .transform(transform.rectangle.rectangle({
                left: 0,
                width: use.scale('horiz')
              }))
                .plot(plot.box({
                  fill: '#f0f0f0',
                  stroke: '#444444',
                }))
                .transform(transform.rectangle.point({ left: 2 }))
                  .plot(plot.label({
                    text: use.fn(
                      use.prop('Edits'), use.prop('Page'),
                      formatEditsAndPage
                    ),
                    baseline: 'middle',
                    size: '9px'
                  }))
                  .render()
    })();
    </script>
  </body>
</html>
