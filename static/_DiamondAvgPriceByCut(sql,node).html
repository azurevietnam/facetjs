<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="style/facet.css">

    <script src="lib/async.js"></script>
    <script src="lib/d3.v3.js"></script>
    <script src="lib/jquery-1.9.1.js"></script>

    <script src="/facet.js"></script>

    <title>Facet Examples (0.4.3)</title>

    <script>
      // The basics
      var filter = facet.filter;
      var split = facet.split;
      var apply = facet.apply;
      var layout = facet.layout;
      var scale = facet.scale;
      var plot = facet.plot;
      var use = facet.use;
      var combine = facet.combine;
      var sort = facet.sort;
      var transform = facet.transform;
    </script>
  </head>

  <body>

    <div class="cont">
      <h1>Diamond Avg Price by Carat</h1>
      <h2>SQL Driver in Client / diamonds</h2>
      <div class="example"></div>
    </div>
    <script>
    (function() {
      // {
      //   "carat": "0.23",
      //   "cut": "Ideal",
      //   "color": "E",
      //   "clarity": "SI2",
      //   "depth": "61.5",
      //   "table": "55",
      //   "price": "326",
      //   "x": "3.95",
      //   "y": "3.98",
      //   "z": "2.43"
      // },

      var mySqlRequester = facet.driver.proxy.ajax({
        url: '/pass/sql',
        pretty: true
      });

      var sqlDriverClient = facet.driver.sql({
        requester: mySqlRequester,
        table: "diamonds",
        filter: null
      });

      /*
      var vis = facet.define('.example', 800, 600, sqlDriverClient)
        .scale('vert', scale.linear())
        .scale('color', scale.color())
          .split('Cut', split.identity('cut'))
          .apply('AvgPrice', apply.average('price'))
          .combine(combine.slice(sort.natural('AvgPrice', 'descending')))
          .layout(layout.horizontal({ gap: 3 }))
          .domain('vert', use.interval(0, use.prop('AvgPrice')))
          .range('vert', use.space('height'))
          .domain('color', use.prop('Cut'))
          .transform(transform.rectangle.rectangle({
            bottom: 0,
            height: use.scale('vert')
          }))
            .plot(plot.box({
              fill: '#f0f0f0',
              stroke: use.scale('color')
            }))
            .transform(transform.rectangle.point({ bottom: 6 }))
              .plot(plot.label({
                text: use.prop('Cut'),
                color: use.scale('color'),
                anchor: 'middle',
                baseline: 'bottom'
              }))
      */


      facet() // [{}]
        .container('.example', 'svg')
        .def("diamonds",
          facet(sqlDriverClient)
            .filter("color = 'D")
            .def(Mark.box(...))
        )


      facet() // [{}]
        .container('.example', 'svg')
        .def("diamonds",
          facet(sqlDriverClient)
            .filter("color = 'D")
            .def("priceOver2", "$price/2")
        )
        // [{ diamonds: <Dataset> }]
        .def('stage', Shape.rectangle(800, 600))
        // [{ diamonds: <Dataset>, stage: '<shape 800x600>' }]
        .def('Count', '$diamonds.count()')
        // [{ diamonds: <Dataset>, stage: '<shape>', Count: 2342 }]
        .def('verticalScale', Scale.linear())
        .def('colorScale', Scale.color())
        .def('Cuts',
          facet("diamonds").split("cut", 'Cut')
            // [
            //   {
            //     Cut: 'good'
            //   }
            //   {
            //     Cut: 'v good'
            //   }
            //   {
            //     Cut: 'ideal'
            //   }
            // ]
            .def('diamonds', facet('diamonds').filter('cut = $Cut'))
            // [
            //   {
            //     Cut: 'good'
            //     diamnods: <dataset cut=good>
            //   }
            //   {
            //     Cut: 'v good'
            //     diamnods: <dataset cut=v good>
            //   }
            //   {
            //     Cut: 'ideal'
            //     diamnods: <dataset cut=ideal>
            //   }
            // ]
            .def('Count', facet('diamonds').count().divide('Count'))
            .def('AvgPrice', '$diamonds.sum("price") / $diamonds.count()')
            .sort('AvgPrice', 'descending')
            .limit(10)
            .def('AccAvgPrice', 'AvgPrice')
            .def('stage', Layout.horizontal('stage', { gap: 3 }))
            .train('verticalScale', 'domain', '$AvgPrice')
            .train('verticalScale', 'range', '$stage.height')
            .train('color', 'domain', '$Cut')
            .def('barStage', function(d) {
              return Transform.margin(d.stage, {
                bottom: 0,
                height: d.verticalScale(d.AvgPrice)
              })
            })
            .def('barStage1', Transform.margin('stage', {
                bottom: 0,
                height: '$verticalScale($AvgPrice)'
              })
            )
            .def('barStage2', "stage.margin(bottom=0, height=$verticalScale($AvgPrice))")
            .def('Bars', Mark.box('barStage', {
              type: 'box',
              fill: '#f0f0f0',
              stroke: use('color')
            }))// access anchors via Bars.left e.t.c
            .def('pointStage', Transform.margin('barStage', {
                bottom: 6
            }))
            .def(Mark.label('pointStage', {
              text: '$Cut',
              color: '$color',
              anchor: 'middle',
              baseline: 'bottom'
            })) // Used without name
        )
        .compute()

    })();
    </script>
  </body>
</html>
