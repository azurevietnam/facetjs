<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="style/facet.css">

    <script src="lib/async.js"></script>
    <script src="lib/jquery-1.9.1.js"></script>

    <script src="/facet.js"></script>

    <title>Split-Apply-Combine Test</title>
  </head>

  <body>
    <div class="test-cont">
      <textarea id="input"></textarea>
      <div class="driver-selector">
        <label for="driver">Driver:</label>
        <select id="driver">
          <option selected>Druid</option>
          <option>SQL</option>
        </select>
        <label for="resource">resource:</label><input id="resource" type="text"></input>
        <label for="data-source">data source:</label><input id="data-source" type="text"></input>
      </div>
      <pre id="output"></pre>
      <button id="send">Send</button>
      <div class="button-bar">
        <button id="add-split">Add Split</button>
        <button id="add-apply">Add Apply</button>
        <button id="add-combine">Add Combine</button>
        <button id="pop-last">Pop Last</button>
      </div>
      <div class="time-show"></div>
    </div>
    <script>
    (function() {
      var d3 = facet.d3;

      // Init
      var defaultQuery = JSON.stringify([{
        "operation": "apply",
        "name": "Count",
        "aggregate": "count"
      }], null, 2);

      d3.select("#resource").property("value", localStorage['resource'] || '10.20.30.40');
      d3.select("#data-source").property("value", localStorage['dataSource'] || 'koalas');
      d3.select("#input").property("value", localStorage['query'] || defaultQuery);

      var addObj = function(obj) {
        return function() {
          var input = d3.select("#input").property("value");

          if (input == '') return;

          try {
            input = JSON.parse(input);
          } catch (e) {
            return;
          }

          if (!Array.isArray(input)) return;
          input.push(obj);

          d3.select("#input")
            .property("value", JSON.stringify(input, null, 2))
        }
      }

      d3.select("#add-split")
        .on('click', addObj({
          operation: "split",
          bucket: "identity",
          attribute: "???",
          name: "???"
        }))

      d3.select("#add-apply")
        .on('click', addObj({
          operation: "apply",
          aggregate: "sum",
          attribute: "???",
          name: "???"
        }))

      d3.select("#add-combine")
        .on('click', addObj({
          operation: "combine",
          method: "slice",
          sort: {
            compare: "natural",
            direction: "descending",
            prop: "???"
          },
          limit: 5
        }))

      d3.select("#pop-last")
        .on('click', function() {
          var input = d3.select("#input").property("value");

          if (input == '') return;

          try {
            input = JSON.parse(input);
          } catch (e) {
            return;
          }

          if (!Array.isArray(input)) return;
          if (input.length < 1) return;
          input.pop();

          d3.select("#input")
            .property("value", JSON.stringify(input, null, 2))
        })

      function saveToLocal() {
        localStorage['resource'] = d3.select("#resource").property("value");
        localStorage['dataSource'] = d3.select("#data-source").property("value");
        localStorage['query'] = d3.select("#input").property("value");
      }

      function getDriver() {
        var driverStr = d3.select("#driver").property("value")

        if (driverStr === "SQL") {
          // SQL
          var sqlRequester = facet.requester.proxy.ajax({
            url: '/pass/sql',
            prety: true
          });

          return facet.driver.sql({
            requester: sqlRequester,
            table: "diamonds"
          });
        }

        if (driverStr === "Druid") {
          // DRUID
          var druidRequester = facet.requester.proxy.ajax({
            url: '/pass/druid',
            prety: true,
            context: {
              resource: d3.select("#resource").property("value")
            }
          });

          // These are there for testing
          var attributeMetas = {
            app_name: facet.AttributeMeta.fromJS({
              type: 'large'
            })
          };

          return facet.driver.druid({
            requester: druidRequester,
            dataSource: d3.select("#data-source").property("value"),
            timeAttribute: 'timestamp',
            attributeMetas: attributeMetas,
            forceInterval: true,
            concurrentQueryLimit: 7,
            queryLimit: 70
          });
        }
      }

      d3.select('#send')
        .on('click', function() {
          var driver = getDriver();
          var input = d3.select("#input").property("value");

          if (input == '') return;

          try {
            input = JSON.parse(input);
          } catch (e) {
            try {
              input = eval('(' + input + ')');
            } catch (e) {
              d3.select("#output")
                .text("Could not parse JSON");
              throw e;
            }
          }

          saveToLocal();

          try {
            input = new facet.FacetQuery(input);
          } catch (e) {
            d3.select("#output")
              .text("Error in query: " + e.message);
            throw e;
          }

          var start = Date.now();
          driver({ query: input }, function(err, res) {
            if (err) {
              d3.select("#output").text("An error occurred:\n" + err.message);
              d3.select('.time-show').text("Query had an error");
              console.log(err);
              return;
            }

            var taken = Date.now() - start;
            d3.select('.time-show')
              .text('Query took ' + taken + 'ms');

            d3.select("#output")
              .text(JSON.stringify(res, null, 2));
          })
        })
    })();
    </script>

  </body>
</html>
