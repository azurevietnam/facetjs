<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="facet.css">
    <script src="lib/underscore.js"></script>
    <script src="lib/async.js"></script>
    <script src="lib/d3.v3.js"></script>
    <script src="lib/jquery-1.9.1.js"></script>
    <script src="facet.js"></script>
    <script src="driverUtil.js"></script>
    <script src="simpleDriver.js"></script>
    <script src="sqlDriver.js"></script>
    <script src="druidDriver.js"></script>

    <title>Split-Apply-Combine Test</title>
  </head>

  <body>
    <div class="test-cont">
      <textarea id="input">[
  {
    "type": "within",
    "attribute": "time",
    "range": [
      "2013-04-21T00:00:00.000Z",
      "2013-04-23T00:00:00.000Z"
    ],
    "operation": "filter"
  },
  {
    "operation": "split",
    "bucket": "identity",
    "attribute": "language",
    "name": "Language"
  },
  {
    "operation": "apply",
    "aggregate": "sum",
    "attribute": "count",
    "name": "Count"
  },
  {
    "operation": "combine",
    "combine": "slice",
    "sort": {
      "compare": "natural",
      "direction": "descending",
      "prop": "Count"
    },
    "limit": 4
  },
  {
    "operation": "split",
    "bucket": "identity",
    "attribute": "page",
    "name": "Page"
  },
  {
    "operation": "apply",
    "aggregate": "sum",
    "attribute": "count",
    "name": "Count"
  },
  {
    "operation": "combine",
    "combine": "slice",
    "sort": {
      "compare": "natural",
      "direction": "descending",
      "prop": "Count"
    },
    "limit": 2
  }
]</textarea>
      <div class="driver-selector">
        <label for="driver">Driver:</label>
        <select id="driver">
          <option selected>Druid</option>
          <option>SQL</option>
        </select>
        <label for="host">host:</label><input id="host" type="text" value="10.108.62.62"></input> <!-- 10.60.134.138 -->
        <label for="port">port:</label><input id="port" type="text" value="8080"></input>
        <label for="data-source">data source:</label><input id="data-source" type="text" value="openx"></input> <!-- wikipedia_editstream -->
      </div>
      <pre id="output"></pre>
      <button id="send">Send</button>
      <div class="button-bar">
        <button id="add-split">Add Split</button>
        <button id="add-apply">Add Apply</button>
        <button id="add-combine">Add Combine</button>
        <button id="pop-last">Pop Last</button>
      </div>
      <div class="time-show"></div>
    </div>
    <script>
    (function() {
      var addObj = function(obj) {
        return function() {
          var input = d3.select("#input").property("value");

          if (input == '') return;

          try {
            input = JSON.parse(input);
          } catch (e) {
            return;
          }

          if (!Array.isArray(input)) return;
          input.push(obj);

          d3.select("#input")
            .property("value", JSON.stringify(input, null, 2))
        }
      }


      d3.select("#add-split")
        .on('click', addObj({
          operation: "split",
          bucket: "identity",
          attribute: "???",
          name: "???"
        }))

      d3.select("#add-apply")
        .on('click', addObj({
          operation: "apply",
          aggregate: "sum",
          attribute: "???",
          name: "???"
        }))

      d3.select("#add-combine")
        .on('click', addObj({
          operation: "combine",
          combine: "slice",
          sort: {
            compare: "natural",
            direction: "descending",
            prop: "???"
          },
          limit: 5
        }))

      d3.select("#pop-last")
        .on('click', function() {
          var input = d3.select("#input").property("value");

          if (input == '') return;

          try {
            input = JSON.parse(input);
          } catch (e) {
            return;
          }

          if (!Array.isArray(input)) return;
          if (input.length < 1) return;
          input.pop();

          d3.select("#input")
            .property("value", JSON.stringify(input, null, 2))
        })

      function getDriver() {
        var driverStr = d3.select("#driver").property("value")

        if (driverStr === "SQL") {
          // SQL
          var sqlRequester = facet.ajaxPoster({
            url: '/pass/sql',
            prety: true
          });

          var sqlDriverClient = sqlDriver({
            requester: sqlRequester,
            table: "wiki_day_agg"
          });
        }

        if (driverStr === "Druid") {
          // DRUID
          var druidRequester = facet.ajaxPoster({
            url: '/pass/druid',
            prety: true,
            context: {
              host: d3.select("#host").property("value"),
              port: d3.select("#port").property("value")
            }
          });

          return druidDriver({
            requester: druidRequester,
            dataSource: d3.select("#data-source").property("value"),
            timeAttribute: 'timestamp',

            forceInterval: true,
            concurrentQueryLimit: 7,
            queryLimit: 70
          });
        }
      }

      d3.select('#send')
        .on('click', function() {
          var driver = getDriver();
          var input = d3.select("#input").property("value");

          if (input == '') return;

          try {
            input = JSON.parse(input);
          } catch (e) {
            d3.select("#output")
              .text("Could not parse JSON");
            return;
          }

          var start = Date.now();
          driver(input, function(err, res) {
            if (err) {
              d3.select("#output").text("An error occurred:\n" + err.message);
              d3.select('.time-show').text("Query had an error");
              throw err;
              return;
            }

            var taken = Date.now() - start;
            d3.select('.time-show')
              .text('Query took ' + taken + 'ms');

            d3.select("#output")
              .text(JSON.stringify(res, null, 2));
          })
        })
    })();
    </script>

  </body>
</html>













