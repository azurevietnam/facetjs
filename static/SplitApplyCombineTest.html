<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="facet.css">
    <script src="lib/underscore.js"></script>
    <script src="lib/async.js"></script>
    <script src="lib/d3.v3.js"></script>
    <script src="lib/jquery-1.9.1.js"></script>
    <script src="lib/date.js"></script>
    <script src="lib/timezoneinfo.js"></script>
    <script src="query.js"></script>
    <script src="facet.js"></script>
    <script src="chronology.js"></script>
    <script src="driverUtil.js"></script>
    <script src="simpleDriver.js"></script>
    <script src="sqlDriver.js"></script>
    <script src="druidDriver.js"></script>

    <title>Split-Apply-Combine Test</title>
  </head>

  <body>
    <div class="test-cont">
      <textarea id="input">[
  {
    "operation": "dataset",
    "datasets": [
      "main",
      "prev"
    ]
  },
  {
    "type": "within",
    "dataset": "main",
    "attribute": "timestamp",
    "range": [
      "2013-10-18T07:00:00.000Z",
      "2013-10-24T22:01:00.001Z"
    ],
    "operation": "filter"
  },
  {
    "type": "within",
    "dataset": "prev",
    "attribute": "timestamp",
    "range": [
      "2013-10-11T07:00:00.000Z",
      "2013-10-17T22:01:00.001Z"
    ],
    "operation": "filter"
  },
  {
    "bucket": "parallel",
    "name": "region_lookup",
    "splits": [
      {
        "bucket": "identity",
        "dataset": "main",
        "attribute": "region_lookup"
      },
      {
        "bucket": "identity",
        "dataset": "prev",
        "attribute": "region_lookup"
      }
    ],
    "operation": "split"
  },
  {
    "name": "count",
    "aggregate": "sum",
    "attribute": "count",
    "operation": "apply"
  },
  {
    "name": "count_delta_",
    "arithmetic": "multiply",
    "operands": [
      {
        "arithmetic": "divide",
        "operands": [
          {
            "arithmetic": "subtract",
            "operands": [
              {
                "dataset": "main",
                "aggregate": "sum",
                "attribute": "count"
              },
              {
                "dataset": "prev",
                "aggregate": "sum",
                "attribute": "count"
              }
            ]
          },
          {
            "dataset": "prev",
            "aggregate": "sum",
            "attribute": "count"
          }
        ]
      },
      {
        "aggregate": "constant",
        "value": 100
      }
    ],
    "operation": "apply"
  },
  {
    "method": "slice",
    "sort": {
      "compare": "natural",
      "prop": "count",
      "direction": "descending"
    },
    "limit": 13,
    "operation": "combine"
  }
]</textarea>
      <div class="driver-selector">
        <label for="driver">Driver:</label>
        <select id="driver">
          <option selected>Druid</option>
          <option>SQL</option>
        </select>
        <label for="host">host:</label><input id="host" type="text" value="10.209.98.48"></input> <!-- 10.108.62.62 -->
        <label for="port">port:</label><input id="port" type="text" value="8080"></input>
        <label for="data-source">data source:</label><input id="data-source" type="text" value="wikipedia_editstream"></input> <!-- openx -->
      </div>
      <pre id="output"></pre>
      <button id="send">Send</button>
      <div class="button-bar">
        <button id="add-split">Add Split</button>
        <button id="add-apply">Add Apply</button>
        <button id="add-combine">Add Combine</button>
        <button id="pop-last">Pop Last</button>
      </div>
      <div class="time-show"></div>
    </div>
    <script>
    (function() {
      var addObj = function(obj) {
        return function() {
          var input = d3.select("#input").property("value");

          if (input == '') return;

          try {
            input = JSON.parse(input);
          } catch (e) {
            return;
          }

          if (!Array.isArray(input)) return;
          input.push(obj);

          d3.select("#input")
            .property("value", JSON.stringify(input, null, 2))
        }
      }


      d3.select("#add-split")
        .on('click', addObj({
          operation: "split",
          bucket: "identity",
          attribute: "???",
          name: "???"
        }))

      d3.select("#add-apply")
        .on('click', addObj({
          operation: "apply",
          aggregate: "sum",
          attribute: "???",
          name: "???"
        }))

      d3.select("#add-combine")
        .on('click', addObj({
          operation: "combine",
          combine: "slice",
          sort: {
            compare: "natural",
            direction: "descending",
            prop: "???"
          },
          limit: 5
        }))

      d3.select("#pop-last")
        .on('click', function() {
          var input = d3.select("#input").property("value");

          if (input == '') return;

          try {
            input = JSON.parse(input);
          } catch (e) {
            return;
          }

          if (!Array.isArray(input)) return;
          if (input.length < 1) return;
          input.pop();

          d3.select("#input")
            .property("value", JSON.stringify(input, null, 2))
        })

      function getDriver() {
        var driverStr = d3.select("#driver").property("value")

        if (driverStr === "SQL") {
          // SQL
          var sqlRequester = facet.ajaxPoster({
            url: '/pass/sql',
            prety: true
          });

          var sqlDriverClient = sqlDriver({
            requester: sqlRequester,
            table: "wiki_day_agg"
          });
        }

        if (driverStr === "Druid") {
          // DRUID
          var druidRequester = facet.ajaxPoster({
            url: '/pass/druid',
            prety: true,
            context: {
              host: d3.select("#host").property("value"),
              port: d3.select("#port").property("value")
            }
          });

          return druidDriver({
            requester: druidRequester,
            dataSource: d3.select("#data-source").property("value"),
            timeAttribute: 'timestamp',

            forceInterval: true,
            concurrentQueryLimit: 7,
            queryLimit: 70
          });
        }
      }

      d3.select('#send')
        .on('click', function() {
          var driver = getDriver();
          var input = d3.select("#input").property("value");

          if (input == '') return;

          try {
            input = JSON.parse(input);
          } catch (e) {
            d3.select("#output")
              .text("Could not parse JSON");
            throw e;
          }

          try {
            input = new query.FacetQuery(input);
          } catch (e) {
            d3.select("#output")
              .text("Error in query: " + e.message);
            throw e;
          }

          var start = Date.now();
          driver({ query: input }, function(err, res) {
            if (err) {
              d3.select("#output").text("An error occurred:\n" + err.message);
              d3.select('.time-show').text("Query had an error");
              console.log(err);
              return;
            }

            var taken = Date.now() - start;
            d3.select('.time-show')
              .text('Query took ' + taken + 'ms');

            d3.select("#output")
              .text(JSON.stringify(res, null, 2));
          })
        })
    })();
    </script>

  </body>
</html>













