<!DOCTYPE html>
<html>
  <head>
    <!--
    Forgive me but this is a prototype :-)
    -->
    <link rel="stylesheet/less" type="text/css" href="facet.less">
    <script src="lib/less-1.3.0.min.js"></script>
    <script src="lib/underscore.js"></script>
    <script src="lib/async.js"></script>
    <script src="lib/d3.js"></script>
    <script src="lib/jquery-1.9.1.js"></script>
    <script src="facet.js"></script>
    <script src="simple.js"></script>
    <script src="sql.js"></script>
    <script src="druid.js"></script>
    <title>Facet v0.2</title>
  </head>

  <body>
    <div class="cont">
    </div>
    <script>
      window.data1 = (function() {
        var now, pick, w;
        pick = function(arr) {
          return arr[Math.floor(Math.random() * arr.length)];
        };
        now = Date.now();
        w = 100;
        return d3.range(400).map(function(i) {
          return {
            id: i,
            time: new Date(now + i * 13 * 1000),
            letter: 'ABC'[Math.floor(3 * i / 400)],
            number: pick([1, 10, 3, 4]),
            scoreA: i * Math.random() * Math.random(),
            scoreB: 10 * Math.random(),
            walk: w += Math.random() - 0.5 + 0.02
          };
        });
      })();

      // var query = [
      //   { operation: 'apply', prop: 'SumScoreA', aggregate: 'sum', attribute: 'scoreA' },
      //   { operation: 'split', prop: 'Letter', bucket: 'natural', attribute: 'letter' },
      //   { operation: 'apply', prop: 'SumScoreA', aggregate: 'sum', attribute: 'scoreA' }
      // ];
      var simpleDriver = facet.driver.simple(data1);
      // simpleDriver(query, function(err, res) {
      //   if (err) {
      //     console.log("ERROR");
      //     throw err;
      //   }

      //   console.log(res);
      // });

      var split = facet.split;
      var apply = facet.apply;
      var layout = facet.layout;
      var plot = facet.plot;
      var prop = facet.prop;
      var sort = facet.sort;
      var stage = facet.stage;

      var driver = simpleDriver;
      // var driver = facet.ajaxPostDriver({
      //   url: '/driver/simple',
      //   context: { data: 'data1' },
      //   prety: true
      // });

      var rect1 = facet.visualize(driver)
        .split('Letter', split.natural('letter'))
        .apply('avgScoreA', apply.average('scoreA'))
        .layout(layout.vertical({ size: prop('avgScoreA'), gap: 5 }))
        .plot(plot.rect({ color: 'none' }))
        .stage(stage.rectToPoint(0.5, 0.5)).plot(plot.text({ text: prop('Letter'), color: 'green' })).pop()
        .render('.cont', 800, 600)
          // .split('Time', split.time('time', 'minute'))
          // .layout(layout.horizontal({ gap: 2 }))
          // .plot(plot.rect({ color: '#ccccff' }))
          // .stage(stage.rectToPoint(0.5, 0.5)).plot(plot.text({ text: prop('Number'), color: 'red' })).pop()
          // .render('.cont', 800, 600)


      // q = {"intervals":["2013-02-04T00:00:00.000/2013-02-24T00:00:00.000"],"aggregations":[{"type":"doubleSum","name":"count","fieldName":"count"},{"type":"hyperUnique","name":"uniques","fieldName":"unique_users"},{"type":"doubleSum","name":"delta","fieldName":"delta"},{"type":"doubleSum","name":"added","fieldName":"added"},{"type":"doubleSum","name":"deleted","fieldName":"deleted"}],"postAggregations":[{"type":"arithmetic","name":"variation","fn":"-","fields":[{"type":"fieldAccess","name":"added","fieldName":"added"},{"type":"fieldAccess","name":"deleted","fieldName":"deleted"}]},{"type":"arithmetic","name":"average_variation","fn":"/","fields":[{"type":"fieldAccess","name":"variation","fieldName":"variation"},{"type":"fieldAccess","name":"count","fieldName":"count"}]}],"dataSource":"wikipedia_editstream","granularity":"hour","queryType":"timeseries"}

      // facet.ajaxPostDriver({
      //   url: '/pass/druid',
      //   prety: true
      // })(q)

      // var druidRequester = facet.ajaxPostDriver({
      //   url: '/pass/druid',
      //   prety: true
      // })

      // "dimensions":
      //   ["dma_code","continent_code","geo","area_code","robot","country_name","network","city","namespace","anonymous","unpatrolled","page","postal_code","language","newpage","user","region_lookup"],
      // "metrics":
      //   ["count","added","variation","delta","delta_hist","unique_users","deleted"]
      var druidQ = [
        { operation: 'apply', prop: 'Edits', aggregate: 'count' },
        { operation: 'split', prop: 'Language', bucket: 'natural', attribute: 'language' },
        { operation: 'apply', prop: 'Edits', aggregate: 'count' },
        { operation: 'combine', sort: { prop: 'Edits', compare: 'natural', direction: 'DESC' }, limit: 5 },
        { operation: 'split', prop: 'Page', bucket: 'natural', attribute: 'page' },
        { operation: 'apply', prop: 'Edits', aggregate: 'count' },
        { operation: 'combine', sort: { prop: 'Edits', compare: 'natural', direction: 'DESC' }, limit: 4 },
      ];
      // var druidDriver = facet.driver.druid({
      //   requester: druidRequester,
      //   dataSource: "wikipedia_editstream",
      //   interval: [new Date(Date.UTC(2013, 2-1, 14, 0, 0, 0)), new Date(Date.UTC(2013, 2-1, 20, 0, 0, 0))],
      //   filters: null
      // })(druidQ, function(err, result) {
      //   console.log('got', err, result);
      // })

      // facet.ajaxPostDriver({
      //   url: '/driver/druid',
      //   context: { data: 'data1' },
      //   prety: true
      // })(druidQ, function(err, result) {
      //   console.log('got', err, result);
      // })

      var sqlRequester = facet.ajaxPostDriver({
        url: '/pass/sql',
        prety: true
      })

      var sqlQ = [
        { operation: 'apply', prop: 'Diamonds', aggregate: 'count' },
        { operation: 'split', prop: 'Cut', bucket: 'natural', attribute: 'cut' },
        { operation: 'apply', prop: 'Num', aggregate: 'count' },
        { operation: 'apply', prop: 'AvgPrice', aggregate: 'average', attribute: 'price' },
        { operation: 'combine', sort: { prop: 'AvgPrice', compare: 'natural', direction: 'DESC' } },
        // { operation: 'split', prop: 'Page', bucket: 'natural', attribute: 'page' },
        // { operation: 'apply', prop: 'Edits', aggregate: 'count' },
        // { operation: 'combine', sort: { prop: 'Edits', compare: 'natural', direction: 'DESC' }, limit: 4 },
      ];

      var sqlDriver = facet.driver.sql({
        requester: sqlRequester,
        table: "diamonds",
        filters: null
      })(sqlQ, function(err, result) {
        console.log('got', err, result);
      })
    </script>
  </body>
</html>
