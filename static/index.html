<!DOCTYPE html>
<html>
  <head>
    <!--
    Forgive me but this is a prototype :-)
    -->
    <link rel="stylesheet/less" type="text/css" href="facet.less">
    <script src="lib/less-1.3.0.min.js"></script>
    <script src="lib/underscore.js"></script>
    <script src="lib/async.js"></script>
    <script src="lib/d3.js"></script>
    <script src="lib/jquery-1.9.1.js"></script>
    <script src="facet.js"></script>
    <script src="driverUtil.js"></script>
    <script src="simpleDriver.js"></script>
    <script src="sqlDriver.js"></script>
    <script src="druidDriver.js"></script>

    <title>Facet Examples (0.0.4)</title>

    <script>
      // Some data
      window.data1 = (function() {
        var now, pick, w;
        pick = function(arr) {
          return arr[Math.floor(Math.random() * arr.length)];
        };
        now = Date.now();
        w = 100;
        return d3.range(400).map(function(i) {
          return {
            id: i,
            time: new Date(now + i * 13 * 1000),
            letter: 'ABC'[Math.floor(3 * i / 400)],
            number: pick([1, 10, 3, 4]),
            scoreA: i * Math.random() * Math.random(),
            scoreB: 10 * Math.random(),
            walk: w += Math.random() - 0.5 + 0.02
          };
        });
      })();

      // The basics
      var split = facet.split;
      var apply = facet.apply;
      var layout = facet.layout;
      var scale = facet.scale;
      var plot = facet.plot;
      var use = facet.use;
      var sort = facet.sort;
      var stage = facet.stage;

    </script>
  </head>

  <body>

    <div class="filler">
      FACET
    </div>

    <div class="cont">
      <h1>1. Number of diamonds by Cut (ordered by Avg Price)</h1>
      <h2>Simple Driver (JS) in Node / diamonds</h2>
      <div id="ex1" class="example"></div>
    </div>
    <script>
    (function() {
      return;
      // {
      //   "carat": "0.23",
      //   "cut": "Ideal",
      //   "color": "E",
      //   "clarity": "SI2",
      //   "depth": "61.5",
      //   "table": "55",
      //   "price": "326",
      //   "x": "3.95",
      //   "y": "3.98",
      //   "z": "2.43"
      // },

      var simpleDriverNode = facet.ajaxPoster({
        url: '/driver/simple',
        context: { data: 'diamonds' },
        prety: true
      });

      var vis = facet.visualize(simpleDriverNode)
        .split('Cut', split.identity('cut'))
        .apply('Count', apply.count())
        .apply('AvgPrice', apply.average('price'))
        .combine({ sort: { prop: 'AvgPrice', direction: 'descending' }})
        .layout(layout.vertical({ size: use.prop('Count'), gap: 3 }))
        .plot(plot.rect({
          fill: use.literal('#f0f0f0'),
          stroke: use.scale.color('Cut')
        }))
        .stage(stage.rectToPoint())
          .plot(plot.text({
            text: use.fn(
              use.prop('Cut'), use.prop('Count'),
              function(cut, count) { return cut + ' (count: ' + count + ")"; }
            ),
            color: use.scale.color('Cut'),
            anchor: use.literal('middle'),
            baseline: use.literal('center')
          }))
        .unstage()
        .render('#ex1', 800, 600)
    })();
    </script>

    <div class="cont">
      <h1>2. Number of diamonds by Cut (ordered by Avg Price)</h1>
      <h2>SQL Driver in Client / diamonds</h2>
      <div id="ex2" class="example"></div>
    </div>
    <script>
    (function() {
      return;
      // {
      //   "carat": "0.23",
      //   "cut": "Ideal",
      //   "color": "E",
      //   "clarity": "SI2",
      //   "depth": "61.5",
      //   "table": "55",
      //   "price": "326",
      //   "x": "3.95",
      //   "y": "3.98",
      //   "z": "2.43"
      // },

      var sqlRequester = facet.ajaxPoster({
        url: '/pass/sql',
        prety: true
      });

      var sqlDriverClient = sqlDriver({
        requester: sqlRequester,
        table: "diamonds",
        filters: null
      });

      var vis = facet.visualize(sqlDriverClient)
        .split('Cut', split.identity('cut'))
        .apply('Count', apply.count())
        .apply('AvgPrice', apply.average('price'))
        .combine({ sort: { prop: 'AvgPrice', direction: 'descending' }})
        .layout(layout.vertical({ size: use.prop('Count'), gap: 3 }))
        .plot(plot.rect({
          fill: use.literal('#f0f0f0'),
          stroke: use.scale.color('Cut')
        }))
        .stage(stage.rectToPoint())
          .plot(plot.text({
            text: use.fn(
              use.prop('Cut'), use.prop('Count'),
              function(cut, count) { return cut + ' (count: ' + count + ")"; }
            ),
            color: use.scale.color('Cut'),
            anchor: use.literal('middle'),
            baseline: use.literal('center')
          }))
        .unstage()
        .render('#ex2', 800, 600)
    })();
    </script>


    <div class="cont">
      <h1>3. Avg Price by Cut</h1>
      <h2>SQL Driver in Client / diamonds</h2>
      <div id="ex3" class="example"></div>
    </div>
    <script>
    (function() {
      //return;
      // {
      //   "carat": "0.23",
      //   "cut": "Ideal",
      //   "color": "E",
      //   "clarity": "SI2",
      //   "depth": "61.5",
      //   "table": "55",
      //   "price": "326",
      //   "x": "3.95",
      //   "y": "3.98",
      //   "z": "2.43"
      // },

      var sqlRequester = facet.ajaxPoster({
        url: '/pass/sql',
        prety: true
      });

      var sqlDriverClient = sqlDriver({
        requester: sqlRequester,
        table: "diamonds",
        filters: null
      });

      var vis = facet.visualize(sqlDriverClient)
        .split('Cut', split.identity('cut'))
        .apply('AvgPrice', apply.average('price'))
        .combine({ sort: { prop: 'AvgPrice', direction: 'descending' }})
        .layout(layout.horizontal({ gap: 3 }))
        .scale('vert', scale.linear({include: 0, domain: use.prop('AvgPrice'), range: 'height'}))
        .plot(plot.rect({
          fill: use.literal('#f0f0f0'),
          stroke: use.scale.color('Cut'),
          bottom: use.literal(0),
          height: use.scaled('vert', use.prop('AvgPrice'))
        }))
        .stage(stage.rectToPoint({ bottom: 6 }))
          .plot(plot.text({
            text: use.prop('Cut'),
            color: use.scale.color('Cut'),
            anchor: use.literal('middle'),
            baseline: use.literal('bottom')
          }))
        .unstage()
        .render('#ex3', 800, 600)
    })();
    </script>

    <div class="cont">
      <h1>4. Avg Price by Cut by Clarity</h1>
      <h2>SQL Driver in Client / diamonds</h2>
      <div id="ex4" class="example"></div>
    </div>
    <script>
    (function() {
      //return;
      // {
      //   "carat": "0.23",
      //   "cut": "Ideal",
      //   "color": "E",
      //   "clarity": "SI2",
      //   "depth": "61.5",
      //   "table": "55",
      //   "price": "326",
      //   "x": "3.95",
      //   "y": "3.98",
      //   "z": "2.43"
      // },



      // var sqlDriverNode = facet.ajaxPoster({
      //   url: '/driver/sql',
      //   context: { table: 'diamonds' },
      //   prety: true
      // });

      var sqlRequester = facet.ajaxPoster({
        url: '/pass/sql',
        prety: true
      });

      var sqlDriverClient = sqlDriver({
        requester: sqlRequester,
        table: "diamonds",
        filters: null
      });

      var vis = facet.visualize(sqlDriverClient)
      .apply('TotalDiamondCount', apply.count())
        .split('Clarity', split.identity('clarity'))
        .apply('AvgPrice', apply.average('price'))
        .combine({ sort: { prop: 'AvgPrice', direction: 'descending' }})
        .layout(layout.horizontal({ gap: 3 }))
        .plot(plot.rect({
          fill: use.literal('none'),
          stroke: use.literal('black')
        }))
        .stage(stage.rectToPoint({ top: 6 }))
          .plot(plot.text({
            text: use.prop('Clarity'),
            anchor: use.literal('middle'),
            baseline: use.literal('top')
          }))
        .unstage()
          .split('Cut', split.identity('cut'))
          .apply('AvgPrice', apply.average('price'))
          .combine({ sort: { prop: 'AvgPrice', direction: 'descending' }})
          .layout(layout.horizontal({ gap: 3 }))
          .scale('vert', 2, scale.linear({include: 0, domain: use.prop('AvgPrice'), range: 'height'}))
          .plot(plot.rect({
            fill: use.literal('#f0f0f0'),
            stroke: use.scale.color('Cut'),
            bottom: use.literal(0),
            height: use.scaled('vert', use.prop('AvgPrice'))
          }))
          .stage(stage.rectToPoint({ bottom: 6 }))
            .plot(plot.text({
              text: use.prop('Cut'),
              color: use.scale.color('Cut'),
              baseline: use.literal('center'),
              angle: use.literal(-90)
            }))
          .unstage()
          .render('#ex4', 800, 600)
    })();
    </script>


    <div class="cont">
      <h1>5. Wiki Edits by Page by Language</h1>
      <h2>Druid Driver in Client / wikipedia</h2>
      <div id="ex5" class="example"></div>
    </div>
    <script>
    (function() {
      return;
      // dimensions
      // ["dma_code","continent_code","geo","area_code","robot","country_name","network","city","namespace","anonymous","unpatrolled","page","postal_code","language","newpage","user","region_lookup"]
      // metrics
      // ["count","added","variation","delta","delta_hist","unique_users","deleted"]}

      var druidRequester = facet.ajaxPoster({
        url: '/pass/druid',
        prety: true
      });

      var druidDriverClient = druidDriver({
        requester: druidRequester,
        dataSource: "wikipedia_editstream",
        interval: [new Date(Date.UTC(2013, 2-1, 14, 0, 0, 0)), new Date(Date.UTC(2013, 2-1, 20, 0, 0, 0))],
        filters: null
      });

      var scale = d3.scale.linear().domain([0, 1200]).range([0, 600])

      var vis = facet.visualize(druidDriverClient)
        .split('Language', split.identity('language'))
        .apply('Edits', apply.count())
        .combine({ sort: { prop: 'Edits', direction: 'descending' }, limit: 4})
        .layout(layout.vertical({ gap: 3 }))
        .plot(plot.rect({
          fill: use.literal('none'),
          stroke: use.literal('black')
        }))
        .stage(stage.rectToPoint({ top: 10, left: 8 }))
          .plot(plot.text({
            text: use.prop('Language'),
            baseline: use.literal('top'),
            size: use.literal('30px')
          }))
        .unstage()
        .stage(stage.rectToPoint({ top: 40, left: 8 }))
          .plot(plot.text({
            text: use.fn(use.prop('Edits'), function(d) { return 'Total edits: ' + d; }),
            baseline: use.literal('top')
          }))
        .unstage()
          .split('Page', split.identity('page'))
          .apply('Edits', apply.count())
          .combine({ sort: { prop: 'Edits', direction: 'descending' }, limit: 4})
          .layout(layout.vertical({ gap: 3 }))
          .plot(plot.rect({
            fill: use.literal('#f0f0f0'),
            stroke: use.literal('#444444'),
            left: use.literal(200),
            width: use.fn(use.prop('Edits'), scale)
          }))
          .stage(stage.rectToPoint({ left: 200 }))
            .plot(plot.text({
              text: use.fn(use.prop('Edits'), use.prop('Page'), function(e, p) {
                return '(' + e + ') ' + p;
              }),
              baseline: use.literal('middle'),
              size: use.literal('9px')
            }))
          .unstage()
          .render('#ex5', 800, 600)
    })();
    </script>

    <div class="cont">
      <h1>6. Wiki Edits by User by Page by Language</h1>
      <h2>Druid Driver in Node / wikipedia</h2>
      <div id="ex6" class="example"></div>
    </div>
    <script>
    (function() {
      return;
      // dimensions
      // ["dma_code","continent_code","geo","area_code","robot","country_name","network","city","namespace","anonymous","unpatrolled","page","postal_code","language","newpage","user","region_lookup"]
      // metrics
      // ["count","added","variation","delta","delta_hist","unique_users","deleted"]}

      var druidDriverNode = facet.ajaxPoster({
        url: '/driver/druid',
        context: {
          dataSource: "wikipedia_editstream",
          interval: [new Date(Date.UTC(2013, 2-1, 14, 0, 0, 0)), new Date(Date.UTC(2013, 2-1, 20, 0, 0, 0))]
        },
        prety: true
      });

      var vis = facet.visualize(druidDriverNode)
        .split('Language', split.identity('language'))
        .apply('Edits', apply.count())
        .combine({ sort: { prop: 'Edits', direction: 'descending' }, limit: 4})
        .layout(layout.vertical({ gap: 3 }))
        .plot(plot.rect({
          fill: use.literal('none'),
          stroke: use.literal('black')
        }))
        .stage(stage.rectToPoint({ top: 10, left: 8 }))
          .plot(plot.text({
            text: use.prop('Language'),
            baseline: use.literal('top'),
            size: use.literal('20px')
          }))
        .unstage()
          .split('Page', split.identity('page'))
          .apply('Edits', apply.count())
          .combine({ sort: { prop: 'Edits', direction: 'descending' }, limit: 4})
          .layout(layout.horizontal({ gap: 3 }))
          .plot(plot.rect({
            fill: use.literal('none'),
            stroke: use.literal('green')
          }))
          .stage(stage.rectToPoint({ bottom: 6 }))
            .plot(plot.text({
              text: use.fn(use.prop('Edits'), use.prop('Page'), function(e, p) {
                var str = '(' + e + ') ' + p;
                var lim = 40;
                if (str.length > lim) {
                  str = str.substring(0, lim) + '...'
                }
                return str;
              }),
              anchor: use.literal('middle'),
              baseline: use.literal('bottom'),
              size: use.literal('9px')
            }))
          .unstage()
            .split('User', split.identity('user'))
            .apply('Edits', apply.count())
            .combine({ sort: { prop: 'Edits', direction: 'descending' }, limit: 3})
            .layout(layout.vertical({ gap: 1, size: use.prop('Edits') }))
            .plot(plot.rect({
              fill: use.literal('black'),
              opacity: 0.15
            }))
            .stage(stage.rectToPoint())
              .plot(plot.text({
                text: use.fn(use.prop('Edits'), function(e) { return '[' + e + ']'; }),
                anchor: use.literal('middle'),
                baseline: use.literal('center'),
                size: use.literal('9px')
              }))
            .unstage()
            .render('#ex6', 800, 600)
    })();
    </script>
  </body>
</html>
