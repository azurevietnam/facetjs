// Generated by CoffeeScript 1.3.1
var http;

http = require('http');

exports.requester = function(_arg) {
  var host, opts, path, port;
  host = _arg.host, port = _arg.port, path = _arg.path;
  opts = {
    host: host,
    port: port,
    path: path,
    method: 'POST',
    headers: {
      'content-type': 'application/json'
    }
  };
  return function(druidQuery, callback) {
    var req;
    druidQuery = new Buffer(JSON.stringify(druidQuery), 'utf-8');
    opts.headers['content-length'] = druidQuery.length;
    req = http.request(opts, function(response) {
      var chunks;
      response.setEncoding('utf8');
      chunks = [];
      response.on('data', function(chunk) {
        chunks.push(chunk);
      });
      response.on('close', function(err) {
        console.log('CLOSE');
      });
      response.on('end', function() {
        chunks = chunks.join('');
        if (response.statusCode !== 200) {
          callback(chunks, null);
          return;
        }
        try {
          chunks = JSON.parse(chunks);
        } catch (e) {
          callback(e, null);
          return;
        }
        callback(null, chunks);
      });
    });
    req.write(druidQuery.toString('utf-8'));
    req.end();
  };
};
