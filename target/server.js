// Generated by CoffeeScript 1.3.1
(function() {
  var app, data, druidPass, druidPost, express, http, simpleDriver;

  express = require('express');

  http = require('http');

  simpleDriver = require('./simple.js');

  druidPost = function(_arg) {
    var host, path, port;
    host = _arg.host, port = _arg.port, path = _arg.path;
    return function(druidQuery, callback) {
      var opts, req;
      opts = {
        host: host,
        port: port,
        path: path,
        method: 'POST',
        headers: {
          'content-type': 'application/json'
        }
      };
      req = http.request(opts, function(response) {
        var chunks;
        response.setEncoding('utf8');
        chunks = [];
        response.on('data', function(chunk) {
          chunks.push(chunk);
        });
        response.on('close', function(err) {
          console.log('CLOSE');
        });
        response.on('end', function() {
          chunks = chunks.join('');
          if (response.statusCode !== 200) {
            callback(chunks, null);
            return;
          }
          try {
            chunks = JSON.parse(chunks);
          } catch (e) {
            callback(e, null);
            return;
          }
          callback(null, chunks);
        });
      });
      req.write(JSON.stringify(druidQuery));
      req.end();
    };
  };

  data = {};

  data.data1 = (function() {
    var i, now, pick, ret, w, _i;
    pick = function(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    };
    now = Date.now();
    w = 100;
    ret = [];
    for (i = _i = 0; _i < 400; i = ++_i) {
      ret.push({
        id: i,
        time: new Date(now + i * 13 * 1000),
        letter: 'ABC'[Math.floor(3 * i / 400)],
        number: pick([1, 10, 3, 4]),
        scoreA: i * Math.random() * Math.random(),
        scoreB: 10 * Math.random(),
        walk: w += Math.random() - 0.5 + 0.02
      });
    }
    return ret;
  })();

  app = express();

  app.disable('x-powered-by');

  app.use(express.compress());

  app.use(express.json());

  app.use(express["static"](__dirname + '/../static'));

  app.use(express["static"](__dirname + '/../target'));

  app.get('/', function(req, res) {
    res.send('Welcome to facet');
  });

  app.post('/driver/simple', function(req, res) {
    var context, query, _ref;
    _ref = req.body, context = _ref.context, query = _ref.query;
    simpleDriver(data[context.data])(query, function(err, result) {
      if (err) {
        res.json(500, err);
        return;
      }
      return res.json(result);
    });
  });

  app.post('/pass/sql', function(req, res) {});

  app.post('/driver/sql', function(req, res) {});

  druidPass = druidPost({
    host: '10.60.134.138',
    port: 8080,
    path: '/druid/v2/'
  });

  app.post('/pass/druid', function(req, res) {
    var context, query, _ref;
    _ref = req.body, context = _ref.context, query = _ref.query;
    druidPass(query, function(err, result) {
      if (err) {
        res.json(500, err);
        return;
      }
      return res.json(result);
    });
  });

  app.post('/driver/druid', function(req, res) {});

  app.listen(9876);

  console.log('Listening on port 9876');

}).call(this);
