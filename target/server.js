// Generated by CoffeeScript 1.3.1
var app, data, druidDriver, druidPass, druidRequester, express, respondWithResult, simpleDriver, sqlDriver, sqlPass, sqlRequester;

express = require('express');

druidRequester = require('./druidRequester').requester;

sqlRequester = require('./mySqlRequester').requester;

simpleDriver = require('./simpleDriver');

druidDriver = require('./druidDriver');

sqlDriver = require('./sqlDriver');

data = {};

data.diamonds = require('../data/diamonds.js');

app = express();

app.disable('x-powered-by');

app.use(express.compress());

app.use(express.json());

app.use(express.directory(__dirname + '/../static'));

app.use(express["static"](__dirname + '/../static'));

app.use(express["static"](__dirname + '/../target'));

app.get('/', function(req, res) {
  res.send('Welcome to facet');
});

respondWithResult = function(res) {
  return function(err, result) {
    if (err) {
      res.json(500, err);
      return;
    }
    res.json(result);
  };
};

app.post('/driver/simple', function(req, res) {
  var context, query, _ref;
  _ref = req.body, context = _ref.context, query = _ref.query;
  simpleDriver(data[context.data])(query, respondWithResult(res));
});

sqlPass = sqlRequester({
  host: 'localhost',
  user: 'root',
  password: 'root',
  database: 'facet'
});

app.post('/pass/sql', function(req, res) {
  var context, query, _ref;
  _ref = req.body, context = _ref.context, query = _ref.query;
  sqlPass(query, respondWithResult(res));
});

app.post('/driver/sql', function(req, res) {
  var context, query, _ref;
  _ref = req.body, context = _ref.context, query = _ref.query;
  sqlDriver({
    requester: sqlPass,
    table: context.table,
    filters: null
  })(query, respondWithResult(res));
});

druidPass = druidRequester({
  host: '10.60.134.138',
  port: 8080,
  path: '/druid/v2/'
});

app.post('/pass/druid', function(req, res) {
  var context, query, _ref;
  _ref = req.body, context = _ref.context, query = _ref.query;
  druidPass(query, respondWithResult(res));
});

app.post('/driver/druid', function(req, res) {
  var context, query, _ref;
  _ref = req.body, context = _ref.context, query = _ref.query;
  druidDriver({
    requester: druidPass,
    dataSource: context.dataSource,
    interval: context.interval.map(function(d) {
      return new Date(d);
    }),
    filters: null
  })(query, respondWithResult(res));
});

app.listen(9876);

console.log('Listening on port 9876');
