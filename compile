#!/bin/bash

echo "Compiling..."
PATH="`pwd`/node_modules/.bin:$PATH"

rm -r build/*

mkdir -p build/parser
mkdir -p build/package

# Style
compass compile --sass-dir src/style/ --css-dir package/style/

# All files
coffee --compile --bare --output build src

# Apply parser
pegjs \
  --export-var "module.exports" \
  src/parser/apply.pegjs \
  build/parser/apply.js

# Filter parser
pegjs \
  --export-var "module.exports" \
  src/parser/filter.pegjs \
  build/parser/filter.js

# Parts
mkdir -p package

browserify build/driver/index.js \
  -o package/driver.js \
  --ignore async \
  --standalone driver

browserify build/render/index.js \
  -o package/render.js \
  --standalone render

browserify build/query/index.js \
  -o package/query.js \
  --standalone query

# All in one
browserify build/facet.js \
  -o package/facet.js \
  --standalone facet

# Web workers
browserify build/worker/simpleDriverWorker.js \
  -o package/simpleDriverWorker.js
